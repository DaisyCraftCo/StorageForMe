<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Backup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: #4a5568; /* gray-700 */
        }
        .tab-btn:hover {
            background-color: #f7fafc; /* gray-100 */
        }
        .tab-btn.active {
            color: #2b6cb0; /* blue-600 */
            border-bottom-color: #2b6cb0; /* blue-600 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Your Personal Cloud Backup</h1>
            <p class="text-gray-600 mt-2">Securely store and access your files from anywhere.</p>
            <p class="text-sm text-gray-500 mt-2">Your User ID: <span id="userId" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="upload-section" class="mb-8 p-6 bg-white rounded-lg shadow-md">
                <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-50">
                    <input type="file" id="file-input" multiple class="hidden">
                    <p class="text-gray-500">Drag & drop your files here or <span class="text-blue-600 font-semibold">click to browse</span></p>
                </div>
                <div id="upload-progress-container" class="mt-4 space-y-2"></div>
            </div>

            <!-- Folder Tabs -->
            <div class="mb-6 bg-white rounded-lg shadow-sm">
                <div id="tabs" class="flex border-b">
                    <button class="tab-btn active" data-category="all">All Files</button>
                    <button class="tab-btn" data-category="image">Photos</button>
                    <button class="tab-btn" data-category="video">Videos</button>
                    <button class="tab-btn" data-category="other">Other</button>
                </div>
            </div>

            <!-- File Gallery -->
            <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- File cards will be inserted here -->
            </div>
             <div id="loading-spinner" class="text-center hidden mt-8">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Loading your files...</p>
            </div>
            <div id="empty-state" class="text-center hidden mt-12">
                <p class="text-gray-500">No files found in this category.</p>
            </div>
        </main>
    </div>

    <!-- Modal for confirmation -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4" id="modal-title">Are you sure?</h2>
            <p id="modal-text" class="mb-6">Do you really want to delete this file? This process cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, deleteDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let userId = null;
        let currentFilter = 'all';

        // --- UI Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const gallery = document.getElementById('gallery');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const userIdSpan = document.getElementById('userId');
        const loadingSpinner = document.getElementById('loading-spinner');
        const tabsContainer = document.getElementById('tabs');
        const emptyState = document.getElementById('empty-state');

        // --- Modal Elements ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalCancel = document.getElementById('modal-cancel');
        const modalConfirm = document.getElementById('modal-confirm');
        let confirmCallback = null;

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdSpan.textContent = userId;
                loadFiles();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                }
            }
        });

        // --- File Handling & Display ---
        
        /**
         * Loads and displays files for the current user from Firestore.
         */
        function loadFiles() {
            if (!userId) return;
            loadingSpinner.classList.remove('hidden');

            const filesCollection = collection(db, `artifacts/${appId}/users/${userId}/files`);
            const q = query(filesCollection);

            onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                gallery.innerHTML = ''; // Clear gallery before rendering
                snapshot.forEach((doc) => {
                    const file = doc.data();
                    const fileCard = createFileCard(doc.id, file);
                    gallery.appendChild(fileCard);
                });
                filterGallery(currentFilter);
            }, (error) => {
                console.error("Error loading files:", error);
                loadingSpinner.classList.add('hidden');
            });
        }

        /**
         * Creates an HTML element for a file card.
         * @param {string} docId - The Firestore document ID.
         * @param {object} fileData - The file data from Firestore.
         * @returns {HTMLElement} The file card element.
         */
        function createFileCard(docId, fileData) {
            const card = document.createElement('div');
            card.className = 'file-card bg-white rounded-lg shadow-md overflow-hidden';
            
            let category = 'other';
            if (fileData.type.startsWith('image/')) {
                category = 'image';
            } else if (fileData.type.startsWith('video/')) {
                category = 'video';
            }
            card.dataset.category = category;

            let preview;
            if (category === 'image') {
                preview = `<img src="${fileData.url}" alt="${fileData.name}" class="w-full h-40 object-cover">`;
            } else if (category === 'video') {
                preview = `<video src="${fileData.url}" class="w-full h-40 object-cover" preload="metadata"></video>`;
            } else {
                preview = `<div class="w-full h-40 bg-gray-200 flex items-center justify-center">
                               <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                           </div>`;
            }

            const fileSize = (fileData.size / 1024 / 1024).toFixed(2); // in MB

            card.innerHTML = `
                ${preview}
                <div class="p-4">
                    <p class="font-semibold text-sm truncate" title="${fileData.name}">${fileData.name}</p>
                    <p class="text-xs text-gray-500">${fileSize} MB</p>
                </div>
                <div class="p-2 bg-gray-50 flex justify-end gap-2">
                    <a href="${fileData.url}" target="_blank" download="${fileData.name}" class="text-blue-500 hover:text-blue-700 p-1 rounded-full" title="Download">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </a>
                    <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full" title="Delete" data-doc-id="${docId}" data-file-path="${fileData.path}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;

            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                const button = e.currentTarget;
                const docId = button.dataset.docId;
                const filePath = button.dataset.filePath;
                showConfirmationModal('Delete File', 'Are you sure you want to delete this file? This action cannot be undone.', () => {
                    deleteFile(docId, filePath);
                });
            });

            return card;
        }

        /**
         * Handles the file upload process.
         * Note: Firebase Storage automatically handles data integrity checks (checksums)
         * during upload and download to prevent file corruption. If a file is corrupted
         * in transit, the upload will fail, and this function will catch the error.
         * @param {File} file - The file to upload.
         */
        function uploadFile(file) {
            if (!userId) return;
            // FIX: Simplified the storage path. It's possible the security rules don't account for the extra 'files' subdirectory.
            const filePath = `artifacts/${appId}/users/${userId}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, file);

            const progressElement = createProgressElement(file.name);
            uploadProgressContainer.appendChild(progressElement);
            const progressBar = progressElement.querySelector('.progress-bar');
            const progressText = progressElement.querySelector('.progress-text');
            const progressContainer = progressElement.querySelector('.progress-container');


            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                },
                (error) => {
                    console.error("Upload failed:", error);
                    // Provide clearer feedback to the user on failure
                    progressText.textContent = 'Upload Failed. Please try again.';
                    progressBar.classList.remove('bg-blue-600');
                    progressBar.classList.add('bg-red-600');
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/files`), {
                        name: file.name,
                        url: downloadURL,
                        path: filePath,
                        type: file.type,
                        size: file.size,
                        createdAt: serverTimestamp()
                    });
                    progressText.textContent = 'Upload Complete!';
                    progressBar.classList.remove('bg-blue-600');
                    progressBar.classList.add('bg-green-600');
                    setTimeout(() => progressElement.remove(), 3000);
                }
            );
        }
        
        function createProgressElement(fileName) {
            const element = document.createElement('div');
            element.className = 'w-full';
            element.innerHTML = `
                <div class="p-2 border rounded-lg">
                    <p class="text-sm font-medium text-gray-700 mb-1 truncate">${fileName}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 progress-container">
                        <div class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-right text-gray-500 mt-1 progress-text">Uploading... 0%</p>
                </div>
            `;
            return element;
        }

        async function deleteFile(docId, filePath) {
            if (!userId) return;
            const fileRef = ref(storage, filePath);
            try {
                await deleteObject(fileRef);
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/files`, docId));
            } catch (error) {
                console.error("Error deleting file:", error);
            }
        }

        // --- Event Listeners & UI Logic ---
        
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.tab-btn')) {
                const category = e.target.dataset.category;
                currentFilter = category;
                filterGallery(category);
            }
        });

        function filterGallery(category) {
            const allCards = gallery.querySelectorAll('.file-card');
            let visibleCount = 0;

            tabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            allCards.forEach(card => {
                const cardCategory = card.dataset.category;
                if (category === 'all' || cardCategory === category) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            emptyState.classList.toggle('hidden', visibleCount > 0);
        }

        // --- Drag and Drop Logic ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('bg-blue-50', 'border-blue-500'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('bg-blue-50', 'border-blue-500'), false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }, false);
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            [...files].forEach(uploadFile);
        }

        // --- Modal Logic ---
        function showConfirmationModal(title, text, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            confirmCallback = onConfirm;
            confirmationModal.style.display = 'block';
        }

        function hideModal() {
            confirmationModal.style.display = 'none';
            confirmCallback = null;
        }

        modalCancel.addEventListener('click', hideModal);
        modalConfirm.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideModal();
        });
        window.addEventListener('click', (event) => {
            if (event.target == confirmationModal) {
                hideModal();
            }
        });

    </script>
</body>
</html>
